(function(){"use strict";var Javelin=Javelin||{};Javelin.Plugin={},Javelin.Component={},Javelin.Prefab={},Javelin.Scene={},Javelin.Env={},Javelin.Asset={},Javelin.AUTO_REGISTER_SELF=!0,Javelin.PI_OVER_180=Math.PI/180,Javelin._180_OVER_PI=180/Math.PI,Javelin.__componentHandlers={},Javelin.__componentRequirements={},Javelin.__pluginHandlers={},Javelin.__prefabs={},Javelin.__scenes={},Javelin.reset=function(){Javelin.__componentHandlers={},Javelin.__componentRequirements={},Javelin.__pluginHandlers={},Javelin.__prefabs={},Javelin.__scenes={}},Javelin.isString=function(value){return"string"==typeof value},Javelin.isEmpty=function(item){for(var key in item)return!1;return!0},Javelin.isFunction=function(value){return"function"==typeof value},Javelin.isObject=function(value){return null!=value&&!Javelin.isArray(value)&&"object"==typeof value},Javelin.isArray=function(value){return"[object Array]"===Object.prototype.toString.apply(value)},Javelin.registerComponent=function(handler){if(!Javelin.isFunction(handler))throw Error("Components must be functions.");if(!handler.alias)throw Error("Components must specify their alias.");if(handler.requires&&!Javelin.isArray(handler.requires))throw Error("Component.requires must be an array in "+handler.alias+".");if(handler.inherits&&!Javelin.isString(handler.inherits))throw Error("Component.inherits should be a reference to another component alias string in ("+handler.alias+").");if(handler.inherits&&handler.requires&&-1!==handler.requires.indexOf(handler.inherits))throw Error("Component cannot both require and inherit the same component, must be one or the other.");Javelin.__componentHandlers[handler.alias]=handler},Javelin.registerPrefab=function(obj){if(!Javelin.isObject(obj))throw Error("Prefabs must be object literals.");if(!obj.name||!Javelin.isString(obj.name))throw Error("Prefabs must specify a string name property!");Javelin.__prefabs[obj.name]=obj},Javelin.registerScene=function(obj){if(!Javelin.isObject(obj))throw Error("Scenes must be object literals.");if(!obj.name||!Javelin.isString(obj.name))throw Error("Scenes must specify a string name property!");Javelin.__scenes[obj.name]=obj},Javelin.registerPlugin=function(handler){if(!Javelin.isFunction(handler))throw Error("Engine plugins must be functions");if(!handler.alias||!Javelin.isString(handler.alias))throw Error("Engine plugins must specify a string alias.");this.__pluginHandlers[handler.alias]=handler},Javelin.getPrefab=function(name){return Javelin.__prefabs[name]||!1},Javelin.getScene=function(name){return Javelin.__scenes[name]||!1},Javelin.getComponentHandler=function(alias){return Javelin.__componentHandlers[alias]||!1},Javelin.getPluginHandler=function(alias){return Javelin.__pluginHandlers[alias]||!1},Javelin.getComponentRequirements=function(alias){return Javelin.__componentRequirements[alias]||[]},Javelin.buildComponentRequirements=function(handler){var reqs=[],getRequirements=function(alias){var handler=Javelin.getComponentHandler(alias);if(!handler)throw Error("Missing component for requirement ["+alias+"]!");if(handler.requires)for(var i=0;handler.requires.length>i;i++){for(var exists=!1,j=0;reqs.length>j;j++)reqs[j].alias===handler.requires[i]&&(exists=!0);exists||(getRequirements(handler.requires[i]),reqs.push(Javelin.getComponentHandler(handler.requires[i])))}};getRequirements(handler.alias),this.__componentRequirements[handler.alias]=reqs},Javelin.unpackPrefabDefinitions=function(){var unpackPrefab=function(prefab){if(prefab.children){var unpackedChildren=[];for(var i in prefab.children){var child=prefab.children[i];Javelin.isString(child)?(unpackPrefab(Javelin.getPrefab(child)),unpackedChildren.push(Javelin.getPrefab(child))):(unpackPrefab(child),unpackedChildren.push(child))}prefab.children=unpackedChildren,Javelin.registerPrefab(prefab)}};for(var alias in Javelin.__prefabs)unpackPrefab(Javelin.getPrefab(alias))},Javelin.initialize=function(){if(Javelin.AUTO_REGISTER_SELF){var key;for(key in Javelin.Component)Javelin.registerComponent(Javelin.Component[key]);for(key in Javelin.Plugin)Javelin.registerPlugin(Javelin.Plugin[key]);for(key in Javelin.Prefab)Javelin.registerPrefab(Javelin.Prefab[key]);for(key in Javelin.Scene)Javelin.registerScene(Javelin.Scene[key])}for(var alias in Javelin.__componentHandlers)Javelin.buildComponentRequirements(Javelin.__componentHandlers[alias]);Javelin.unpackPrefabDefinitions()},Javelin.Asset.AtlasImage=function(data,image){this.image=image,this.x=data.frame.x,this.y=data.frame.y,this.height=data.frame.h,this.width=data.frame.w,data.trimmed?(this.cx=data.spriteSourceSize.x-.5*data.sourceSize.w,this.cy=data.spriteSourceSize.y-.5*data.sourceSize.h):(this.cx=.5*-this.width,this.cy=.5*-this.height)},Javelin.Asset.TexturePackerAtlas=function(json,image){this.image=image,this.imageMeta=json.meta,this.images={};var c=0;for(var name in json.frames){var img=new Javelin.Asset.AtlasImage(json.frames[name],this.image);this.images[name]=img,c++}this.count=c},Javelin.Asset.TiledMap=function(){},Javelin.Component.AudioEmitter=function(gameObject,component){var audio=null,transform=null;component.spatial=!0,component.range=50,component.volume=100,component.getAudioNode=function(){};var activeLoops={};component.playLoop=function(path,cull){cull=cull||!1,activeLoops[path]||(activeLoops[path]=!0,audio.playSound(path,component,transform,!0,cull))},component.playOnce=function(path,cull){cull=cull||!1,audio.playSound(path,component,transform,!1,cull)},component.stopSound=function(path){path=path||!1,audio.stopSound(gameObject.id,path),activeLoops[path]&&(activeLoops[path]=!1)},component.$on("engine.create",function(){audio=gameObject.engine.getPlugin("audio"),transform=gameObject.getComponent("transform2d")}),component.$on("engine.destroy",function(){audio.clearActive(gameObject.id)})},Javelin.Component.AudioEmitter.alias="audioEmitter",Javelin.Component.AudioEmitter.requires=["transform2d"],Javelin.Component.AudioListener=function(gameObject,component){component.range=100,component.dropoff=50,component.getAudioNode=function(){}},Javelin.Component.AudioListener.alias="audioListener",Javelin.Component.AudioListener.requires=["transform2d"],Javelin.Component.Rigidbody2d=function(gameObject,component){var box2d=gameObject.engine.getPlugin("box2d"),transform=gameObject.getComponent("transform2d"),debug=gameObject.engine.debug,bodyDef=null,fixtureDef=null,body=null,fixture=null;component.trigger=!1,component.static=!1,component.bullet=!1,component.density=1,component.friction=0,component.restitution=0,component.damping=.2,component.angularDamping=.3,component.fixedRotation=!1,component.radius=null,component.shape=null,component.height=null,component.width=null,component.applyForce=function(degrees,power){body.ApplyForce(new box2d.Vec2(Math.cos(degrees*Javelin.PI_OVER_180)*power,Math.sin(degrees*Javelin.PI_OVER_180)*power),body.GetWorldCenter())},component.applyForceForward=function(amount){component.applyForce(transform.rotation,amount)},component.applyForceBackward=function(amount){component.applyForce(transform.rotation+180,amount)},component.applyForceLeft=function(amount){component.applyForce(transform.rotation-90,amount)},component.applyForceRight=function(amount){component.applyForce(transform.rotation+90,amount)},component.applyImpulse=function(degrees,power){body.ApplyImpulse(new box2d.Vec2(Math.cos(degrees*Javelin.PI_OVER_180)*power,Math.sin(degrees*Javelin.PI_OVER_180)*power),body.GetWorldCenter())},component.applyImpulseForward=function(amount){component.applyImpulse(transform.rotation,amount)},component.applyImpulseBackward=function(amount){component.applyImpulse(transform.rotation+180,amount)},component.applyImpulseLeft=function(amount){component.applyImpulse(transform.rotation-90,amount)},component.applyImpulseRight=function(amount){component.applyImpulse(transform.rotation+90,amount)},component.applyRotationForce=function(force){body.ApplyTorque(force)},component.applyRotationImpulse=function(){},component.setVelocity=function(degrees,amount){body.SetLinearVelocity(new box2d.Vec2(Math.cos(degrees*Javelin.PI_OVER_180)*amount,Math.sin(degrees*Javelin.PI_OVER_180)*amount))},component.setVelocityForward=function(amount){component.setVelocity(transform.rotation,amount)},component.setVelocityBackward=function(amount){component.setVelocity(transform.rotation+180,amount)},component.setVelocityLeft=function(amount){component.setVelocity(transform.rotation-90,amount)},component.setVelocityRight=function(amount){component.setVelocity(transform.rotation+90,amount)},component.getVelocity=function(){return body.GetLinearVelocity()},component.setAngularVelocity=function(){},component.getAngularVelocity=function(){},component.getInertia=function(){},component.teleport=function(){},component.reset=function(){},component.createBodyDefinition=function(){return bodyDef=new box2d.BodyDef,bodyDef.type=component.static?box2d.Body.b2_staticBody:box2d.Body.b2_dynamicBody,bodyDef.position.x=transform.position.y,bodyDef.position.y=transform.position.y,bodyDef.angle=transform.rotation,bodyDef.linearDamping=component.damping,bodyDef.angularDamping=component.angularDamping,bodyDef.fixedRotation=component.fixedRotation,bodyDef.bullet=component.bullet,bodyDef.userData=gameObject,bodyDef},component.createFixtureDefinition=function(){return fixtureDef=new box2d.FixtureDef,fixtureDef.density=component.density,fixtureDef.restitution=component.restitution,fixtureDef.friction=component.friction,component.trigger&&(fixtureDef.isSensor=!0),fixtureDef.shape=component.createFixtureShape(),fixtureDef},component.createFixtureShape=function(){var shape;if(component.radius)return shape=new box2d.CircleShape(component.radius);if(component.shape){for(var points=component.shape,vecs=[],i=0;points.length>i;i++){var vec=new box2d.Vec2;vec.Set(points[i].x,points[i].y),vecs[i]=vec}return shape=new box2d.PolygonShape,shape.SetAsArray(vecs,vecs.length),shape}if(component.height&&component.width)return shape=new box2d.PolygonShape,shape.SetAsBox(.5*component.width,.5*component.height),shape;if(gameObject.hasComponent("sprite")){var img=gameObject.getComponent("sprite").image;if(img)return shape=new box2d.PolygonShape,shape.SetAsBox(.5*img.width,.5*img.height),shape;throw Error("Cannot create rigidbody shape.")}throw Error("Cannot create rigidbody shape.")},component.setBody=function(newBody){body=newBody},component.getBody=function(){return body},component.setFixture=function(newFixture){fixture=newFixture},component.getFixture=function(){return fixture},component.updateLocation=function(){var pos=body.GetPosition();transform.position.x=pos.x,transform.position.y=pos.y,component.fixedRotation||(transform.rotation=body.GetAngle())},component.$on("engine.create",function(){transform=gameObject.getComponent("transform2d"),box2d=gameObject.engine.getPlugin("box2d"),body.SetPosition(new box2d.Vec2(transform.position.x,transform.position.y)),body.SetAngle(transform.rotation),body.ResetMassData()}),component.$on("box2d.lateUpdate",function(){component.updateLocation()}),debug&&component.$on("canvas2d.draw",function(context){if(context.save(),context.translate(transform.position.x,transform.position.y),context.rotate(transform.rotation*Javelin.PI_OVER_180),context.strokeStyle=component.trigger?"#FF0":"#0F0",context.beginPath(),context.arc(0,0,3,0,2*Math.PI,!0),context.closePath(),context.stroke(),component.image){var img=component.image,topLeftX=0-.5*img.width,topLeftY=0-.5*img.height,height=img.height,width=img.width;context.strokeRect(topLeftX,topLeftY,width,height)}component.radius?(context.beginPath(),context.arc(0,0,component.radius,0,2*Math.PI,!0),context.closePath(),context.stroke()):component.height&&component.width?context.strokeRect(.5*-component.width,.5*-component.height,component.width,component.height):component.shape,context.restore()})},Javelin.Component.Rigidbody2d.alias="rigidbody2d",Javelin.Component.Rigidbody2d.requires=["transform2d"],Javelin.Component.Sprite=function(gameObject,component){component.imagePath=null,component.atlasPath=null,component.image=null,component.visible=!0,component.scale={x:1,y:1};var debug=!1,transform=null;component.$on("engine.create",function(){gameObject.engine&&gameObject.engine.debug&&(debug=!0),transform=gameObject.getComponent("transform2d"),component.imagePath&&(gameObject.disable(),component.atlasPath?gameObject.engine.loadAsset(component.atlasPath,function(atlas){component.image=atlas.images[component.imagePath],gameObject.enable()}):gameObject.engine.loadAsset(component.imagePath,function(image){component.image=image,gameObject.enable()}))}),component.$on("canvas2d.draw",function(context){if(component.image){var pos=transform.position,rot=transform.getWorldRotation();context.save(),context.translate(pos.x,pos.y),context.rotate(rot*Javelin.PI_OVER_180);var scale=component.scale;if(component.image instanceof Javelin.Asset.AtlasImage){var spr=component.image;context.drawImage(spr.image,spr.x,spr.y,spr.width,spr.height,+spr.cx*scale.x,+spr.cy*scale.y,spr.width*scale.x,spr.height*scale.y)}else{var cx,cy;cx=.5*component.image.height,cy=.5*component.image.width;var h=component.image.height*component.scale.y,w=component.image.width*component.scale.x;context.drawImage(component.image,-cx*component.scale.x,-cy*component.scale.y,w,h)}if(debug&&(context.strokeStyle="#F00",context.beginPath(),context.arc(0,0,3,0,2*Math.PI,!0),context.closePath(),context.stroke(),component.image)){var img=component.image,topLeftX=0-.5*img.width*scale.x,topLeftY=0-.5*img.height*scale.y,height=img.height*scale.x,width=img.width*scale.y;context.strokeRect(topLeftX,topLeftY,width,height)}context.restore()}})},Javelin.Component.Sprite.alias="sprite",Javelin.Component.Sprite.requires=["transform2d"],Javelin.Component.SpriteAnimator=function(gameObject,component){component.animations=null,component.defaultAnimation=null;var sprite=gameObject.getComponent("sprite"),animations={},currentFrame=0,currentAnimation=null,animating=!0,playOnce=!0,playOnceCallback=null;component.getCurrentAnimation=function(){return currentAnimation},component.define=function(name,images){animations[name]=images,component.defaultAnimation||(component.defaultAnimation=name)},component.getCurrentAnimation=function(){return currentAnimation},component.play=function(name){animating=!0,playOnce=!1,currentFrame=0,currentAnimation=name},component.playOnce=function(name,callback){animating=!0,playOnce=!0,currentAnimation=name,playOnceCallback=callback},component.start=function(){animating=!0},component.startOnce=function(){animating=!0},component.stop=function(){animating=!1},component.setDefaultAnimation=function(){},component.$on("engine.create",function(){if(component.animations){var numLoaded=0,numTotal=0;sprite.visible=!1;for(var name in component.animations)numTotal++,component.animations[name].atlasPath?gameObject.engine.loadAsset(component.animations[name].atlasPath,function(atlas){var imgs=[];for(var index in component.animations[name].frames)imgs.push(atlas.images[component.animations[name].frames[index]]);component.define(name,imgs),numLoaded++,numLoaded===numTotal&&(gameObject.enable(),sprite.visible=!0)}):gameObject.engine.loadAssets(component.animations[name].frames,function(images){component.define(name,images),numLoaded++,numLoaded===numTotal&&(gameObject.enable(),sprite.visible=!0)})}}),component.$on("engine.update",function(){if(sprite.visible&&animating){var current=currentAnimation||component.defaultAnimation,anim=animations[current];sprite.image=anim[currentFrame],currentFrame=(currentFrame+1)%anim.length,0===currentFrame&&playOnce&&(playOnce=!1,playOnceCallback&&(currentAnimation=component.defaultAnimation,playOnceCallback()))}})},Javelin.Component.SpriteAnimator.alias="spriteAnimator",Javelin.Component.SpriteAnimator.requires=["sprite"],Javelin.Component.Transform2d=function(gameObject,component){var parentTransform;component.position={x:0,y:0},component.rotation=0,component.getWorldX=function(){return parentTransform?parentTransform.position.x+component.position.x:component.position.x},component.getWorldY=function(){return parentTransform?parentTransform.position.y+component.position.y:component.position.y},component.getWorldRotation=function(){return parentTransform?parentTransform.rotation+component.rotation:component.rotation},component.translate=function(x,y){x=x||0,y=y||0,component.position.x+=x,component.position.y+=y},component.rotate=function(degrees){degrees=degrees||0,component.rotation=component.rotation+degrees%360},component.translateForward=function(amount){var radians=component.rotation*Javelin.PI_OVER_180,x=Math.cos(radians)*amount,y=Math.sin(radians)*amount;component.translate(x,y)},component.translateBackward=function(amount){var radians=component.rotation*Javelin.PI_OVER_180,x=-Math.cos(radians)*amount,y=-Math.sin(radians)*amount;component.translate(x,y)},component.translateRight=function(){},component.translateLeft=function(){},component.rotate=function(degrees){degrees=degrees||0,component.rotation=component.rotation+degrees%360},component.$on("engine.create",function(){parentTransform=gameObject.parent?gameObject.parent.getComponent("transform2d"):!1})},Javelin.Component.Transform2d.alias="transform2d",Javelin.AssetLoader=function(basePath){this.assets={},this.baseAssetPath=basePath;var imageLoader=function(loader,relPath,absPath,callback){var img=new Image;img.onabort=img.onerror=img.onload=function(){loader.register(relPath,img),callback(img)},img.src=absPath},imageAtlasLoader=function(loader,relPath,absPath,callback){var json,img,imgPath,rp=relPath;imgPath=rp.substring(0,rp.lastIndexOf("/"));var createAtlas=function(){var atlas=new Javelin.Asset.TexturePackerAtlas(json,img);loader.register(relPath,atlas),callback(atlas)},loadJsonCallback=function(item){json=item;var imagePath=imgPath+"/"+json.meta.image;loader.loadAsset(imagePath,loadImageCallback)},loadImageCallback=function(item){img=item,createAtlas()};loader.loadAssetAsType(relPath,"json",loadJsonCallback)},tiledMapLoader=function(){throw Error("Tiled map loading not yet implemented.")},jsonLoader=function(loader,relPath,absPath,callback){var xhr=new XMLHttpRequest;xhr.open("GET",absPath,!0),xhr.onload=function(){var json=JSON.parse(this.responseText);loader.register(relPath,json),callback(json)},xhr.send()},soundLoader=function(loader,relPath,absPath,callback){console.log(relPath);var xhr=new XMLHttpRequest;xhr.open("GET",absPath,!0),xhr.responseType="arraybuffer",xhr.onload=function(){loader.register(relPath,xhr.response),callback(xhr.response)},xhr.send()};this.loaders={png:imageLoader,jpg:imageLoader,"atlas.json":imageAtlasLoader,"map.json":tiledMapLoader,json:jsonLoader,ogg:soundLoader,mp3:soundLoader}},Javelin.AssetLoader.prototype.loadAsset=function(path,callback){var cached=this.assets[path]||!1;cached&&callback(cached),this.getLoaderForPath(path)(this,path,this.baseAssetPath+path,callback)},Javelin.AssetLoader.prototype.loadAssetAsType=function(path,type,callback){if(!this.loaders[type])throw Error("Unknown asset loader type.");this.loaders[type](this,path,this.baseAssetPath+path,callback)},Javelin.AssetLoader.prototype.loadAssets=function(arr,callback){var assets=this.assets,expected=arr.length,loaded=0,register=function(relPath,obj){if(loaded++,assets[arr.indexOf(relPath)]=obj,loaded===expected&&callback){var sorted=[];for(var i in arr)sorted.push(assets[arr[i]]);callback(sorted)}};for(var i in arr)this.loadAsset(arr[i],function(obj){register(arr[i],obj)})},Javelin.AssetLoader.prototype.register=function(relPath,obj){this.assets[relPath]=obj},Javelin.AssetLoader.prototype.unload=function(relPath){this.assets[relPath]=null},Javelin.AssetLoader.prototype.getLoaderForPath=function(path){for(var key in this.loaders)if(path.substring(path.length-key.length)===key)return this.loaders[key];throw Error("No applicable loader for path ["+path+"] found!")},Javelin.Dispatcher=function(){this.listeners={}},Javelin.Dispatcher.prototype.on=function(name,listener){this.listeners[name]=this.listeners[name]||[],this.listeners[name].push(listener)},Javelin.Dispatcher.prototype.dispatch=function(name,data){for(var cbs=this.listeners[name]||[],l=cbs.length,i=0;l>i;i++)if(!1===cbs[i](data))return!1;return!0},Javelin.Engine=function(environment,config){this.config=config,this.debug=config.debug||!1,this.targetFps=config.stepsPerSecond||1e3/30,this.environment=environment,this.environment.engine=this,this.initialized=!1,this.dispatcher=new Javelin.Dispatcher,this.reset()},Javelin.Engine.PRE_UPDATE=0,Javelin.Engine.POST_UPDATE=1,Javelin.Engine.prototype.reset=function(){this.running=!1,this.updating=!1,this.isRunningSlowly=!1,this.currentFps=0,this.lastUpdateTimeTaken=0,this.gos=[],this.lastGoId=0,this.createdGos=[],this.destroyedGos=[],this.stepId=0,this.time=(new Date).getTime(),this.prevTime=0,this.deltaTime=0,this.sceneDefinition={},this.plugins={},this.currentScene=!1,this.config.loader&&(this.loader=new Javelin.AssetLoader(this.config.loader.assetUrl||""))},Javelin.Engine.prototype.getGameObjectById=function(id){for(var l=this.gos.length,i=0;l>i;i++)if(this.gos[i].id===id)return this.gos[i];return!1},Javelin.Engine.prototype.instantiate=function(mixed){return Javelin.isString(mixed)?this.instantiatePrefab(mixed):this.instantiateObject(mixed)},Javelin.Engine.prototype.instantiatePrefab=function(name){if(!Javelin.__prefabs[name])throw Error("Tried instantiating unknown prefab: "+name);return this.instantiateObject(Javelin.__prefabs[name])},Javelin.Engine.prototype.instantiateObject=function(def,isNestedCall){var go;if(def.fromPrefab?go=this.instantiateObject(Javelin.__prefabs[def.fromPrefab],!0):(go=new Javelin.GameObject,go.layer=def.layer||"default",go.name=def.name||"Anonymous",go.tags=def.tags||[]),go.setId(++this.lastGoId),go.engine=this,def.components)for(var key in def.components){var c=this.addComponentToGameObject(go,key);c.$unserialize(def.components[key])}if(def.children)for(var i in def.children)go.addChild(this.instantiateObject(def.children[i],!0));return isNestedCall||this.__addGameObject(go),go},Javelin.Engine.prototype.addComponentToGameObject=function(go,alias){if(go.hasComponent(alias))return go.getComponent(alias);for(var reqs=Javelin.getComponentRequirements(alias),l=reqs.length,i=0;l>i;i++)this.addComponentToGameObject(go,reqs[i].alias);var handler=Javelin.getComponentHandler(alias);if(!handler)throw Error("Unknown component ["+alias+"] requested");var comp=new Javelin.GameObjectComponent;return comp.$id=go.id,comp.$go=go,comp.$alias=handler.alias,handler(go,comp),go.setComponent(alias,comp),comp},Javelin.Engine.prototype.__addGameObject=function(go){if(this.updating&&go.isRoot())this.createdGos.push(go);else{if(this.gos.push(go),this.pluginsOnGameObjectCreate(go),go.children.length)for(var i in go.children)this.__addGameObject(go.children[i]);if(go.isRoot()){go.enable(),this.pluginsOnPrefabCreate(go);for(var cbs=go.getCallbacks("engine.create",!0)||[],j=0;cbs.length>j;j++)cbs[j]()}}},Javelin.Engine.prototype.destroy=function(go,destroyingNested){if(this.updating)this.destroyedGos.push(go);else{var i;if(!destroyingNested){var cbs=go.getCallbacks("engine.destroy",!0);for(i=0;cbs.length>i;i++)cbs[i]();this.pluginsOnPrefabDestroy(go)}if(go.children){var children=[];for(i in go.children)children.push(go.children[i]);go.abandonChildren();for(i in children)this.destroy(children[i],!0)}this.pluginsOnGameObjectDestroy(go),go.parent&&go.parent.removeChild(go),go.setId(-1),go.engine=null;var index=this.gos.indexOf(go);this.gos.splice(index,1)}},Javelin.Engine.prototype.initialize=function(){var func,obj;if(this.config.autoregisterPlugins)for(func in this.config.autoregisterPlugins)Javelin.registerPlugin(this.config.autoregisterPlugins[func]);if(this.config.autoregisterComponents)for(func in this.config.autoregisterComponents)Javelin.registerComponent(this.config.autoregisterComponents[func]);if(this.config.autoregisterPrefabs)for(obj in this.config.autoregisterPrefabs)Javelin.registerPrefab(this.config.autoregisterPrefabs[obj]);if(this.config.autoregisterScenes)for(obj in this.config.autoregisterScenes)Javelin.registerScene(this.config.autoregisterScenes[obj]);Javelin.initialize(),this.initialized=!0},Javelin.Engine.prototype.run=function(){this.running=!0,this.environment.run(this.targetFps)},Javelin.Engine.prototype.stop=function(callback){this.environment.stop(callback),this.running=!1},Javelin.Engine.prototype.step=function(){this.updating=!0,this.stepId++,this.prevStepTime=this.time,this.time=(new Date).getTime(),this.deltaTime=.001*(this.time-this.prevStepTime),this.updatePlugins(Javelin.Engine.PRE_UPDATE,this.deltaTime),this.updateGameObjects(this.deltaTime),this.updatePlugins(Javelin.Engine.POST_UPDATE,this.deltaTime),this.updating=!1,this.cleanupStep(),this.lastUpdateTimeTaken=(new Date).getTime()-this.time,this.isRunningSlowly=this.lastUpdateTimeTaken>this.targetFps?!0:!1},Javelin.Engine.prototype.stats=function(){console.log("Updated  "+this.gos.length+" gos in "+this.lastUpdateTimeTaken+"ms, targeting "+Math.floor(this.targetFps)+" fps; DT: "+this.deltaTime+" seconds.")},Javelin.Engine.prototype.updateGameObjects=function(deltaTime){for(var l=this.gos.length,i=0;l>i;i++)if(this.gos[i].enabled)for(var cbs=this.gos[i].getCallbacks("engine.update",!1),j=0;cbs.length>j;j++)cbs[j](deltaTime)},Javelin.Engine.prototype.updatePlugins=function(which,deltaTime){for(var i in this.plugins)this.plugins[i].$active&&(Javelin.Engine.PRE_UPDATE===which&&this.plugins[i].$onPreUpdateStep(deltaTime),Javelin.Engine.POST_UPDATE===which&&this.plugins[i].$onPostUpdateStep(deltaTime))},Javelin.Engine.prototype.cleanupStep=function(){var i,lc=this.createdGos.length,ld=this.destroyedGos.length;if(lc)for(i=0;lc>i;i++)this.__addGameObject(this.createdGos[i]);if(ld)for(i=0;ld>i;i++)this.destroy(this.destroyedGos[i]);this.createdGos=[],this.destroyedGos=[]},Javelin.Engine.prototype.pluginsOnGameObjectCreate=function(go){for(var i in this.plugins)this.plugins[i].$onGameObjectCreate(go)},Javelin.Engine.prototype.pluginsOnGameObjectDestroy=function(go){for(var i in this.plugins)this.plugins[i].$onGameObjectDestroy(go)},Javelin.Engine.prototype.pluginsOnPrefabCreate=function(go){for(var i in this.plugins)this.plugins[i].$onPrefabCreate(go)},Javelin.Engine.prototype.pluginsOnPrefabDestroy=function(go){for(var i in this.plugins)this.plugins[i].$onPrefabDestroy(go)},Javelin.Engine.prototype.getCurrentScene=function(){return this.currentScene},Javelin.Engine.prototype.loadScene=function(name,callback){if(this.running){var engine=this;return this.stop(function(){engine.unloadScene(),engine.loadScene(name,callback)}),void 0}this.reset(),this.initialized||this.initialize();var scene=Javelin.getScene(name);if(!scene)throw Error("Tried loading unregistered scene: "+name);this.sceneDefinition=scene,this.currentScene=name;var alias;if(scene.plugins)for(alias in scene.plugins){var config=Javelin.isEmpty(scene.plugins[alias])?{}:scene.plugins[alias];this.loadPlugin(alias,config)}else for(alias in this.config.plugins)this.loadPlugin(alias,{});for(var i=0;scene.objects.length>i;i++)this.instantiate(scene.objects[i]);callback?callback():this.run()},Javelin.Engine.prototype.unloadScene=function(){this.unloadPlugins(),this.reset()},Javelin.Engine.prototype.loadAsset=function(path,callback){return this.loader.loadAsset(path,callback)},Javelin.Engine.prototype.loadAssets=function(arr,callback){return this.loader.loadAssets(arr,callback)},Javelin.Engine.prototype.loadPlugin=function(alias,config){if(!this.plugins[alias]){var handler=Javelin.getPluginHandler(alias);if(!handler)throw Error("Required plugin ["+alias+"] not registered.");Javelin.isEmpty(config)&&(config=this.config&&this.config.plugins&&this.config.plugins[alias]?this.config.plugins[alias]:handler.defaults||{});var plugin=new Javelin.EnginePlugin;plugin.$alias=handler.alias,plugin.$engine=this,handler(plugin,config),plugin.$onLoad(),plugin.$active=!0,this.plugins[plugin.$alias]=plugin}},Javelin.Engine.prototype.unloadPlugin=function(name){var p=this.getPlugin(name);p&&(p.$active=!1,p.$onUnload(),this.plugins[name]=null)},Javelin.Engine.prototype.unloadPlugins=function(){for(var alias in this.plugins)this.unloadPlugin(alias)},Javelin.Engine.prototype.getPlugin=function(alias){return this.plugins[alias]||!1},Javelin.Engine.prototype.on=function(event,callback){this.dispatcher.on(event,callback)},Javelin.Engine.prototype.emit=function(event,data){return this.dispatcher.dispatch(event,data)},Javelin.Engine.prototype.broadcast=function(event,data){if(!this.dispatcher.dispatch(event,data))return!1;for(var i in this.gos)if(this.gos[i].isRoot()&&!this.gos[i].broadcast(event,data))return!1;return!0},Javelin.EnginePlugin=function(){this.$alias="",this.$active=!1,this.$engine=null},Javelin.EnginePlugin.prototype.$onLoad=function(){},Javelin.EnginePlugin.prototype.$onUnload=function(){},Javelin.EnginePlugin.prototype.$onSceneLoaded=function(){},Javelin.EnginePlugin.prototype.$onPreUpdateStep=function(){},Javelin.EnginePlugin.prototype.$onPostUpdateStep=function(){},Javelin.EnginePlugin.prototype.$onGameObjectDestroy=function(){},Javelin.EnginePlugin.prototype.$onGameObjectCreate=function(){},Javelin.EnginePlugin.prototype.$onPrefabCreate=function(){},Javelin.EnginePlugin.prototype.$onPrefabDestroy=function(){},Javelin.Environment=function(){},Javelin.Environment.prototype.initialize=function(){},Javelin.Environment.prototype.validatePlugin=function(){},Javelin.Environment.prototype.run=function(){},Javelin.Environment.prototype.stop=function(){},Javelin.GameObject=function(){this.id=-1,this.name="Anonymous",this.engine=null,this.enabled=!1,this.components={},this.children=[],this.parent=null,this.dispatcher=new Javelin.Dispatcher,this.root=null,this.modified=!1,this.ownCallbackCache={},this.allCallbackCache={},this.tags=[],this.layer="default"},Javelin.GameObject.prototype.destroy=function(){this.engine&&this.engine.destroy(this)},Javelin.GameObject.prototype.setId=function(id){this.id=id;for(var alias in this.components)this.components[alias].$id=id},Javelin.GameObject.prototype.enable=function(){if(this.enabled=!0,this.children)for(var index in this.children)this.children[index].enable();else this.setModified()},Javelin.GameObject.prototype.disable=function(){if(this.enabled=!1,this.children)for(var index in this.children)this.children[index].disable();else this.setModified()},Javelin.GameObject.prototype.setComponent=function(alias,component){component.$alias=alias,component.$id=this.id,this.components[alias]=component,this.setModified()},Javelin.GameObject.prototype.setComponents=function(arr){for(var i in arr){var comp=arr[i];comp.$id=this.id,this.components[comp.$alias]=comp}this.setModified()},Javelin.GameObject.prototype.getComponent=function(name){return this.components[name]||!1},Javelin.GameObject.prototype.hasComponent=function(name){return this.components[name]?!0:!1},Javelin.GameObject.prototype.getComponentsInChildren=function(name){for(var components=[],i=0;this.children.length>i;i++){var c=this.children[i];if(c.children)for(var comps=c.getComponentsInChildren(name),j=0;comps.length>j;j++)components.push(comps[j]);var component=c.getComponent(name);component&&components.push(component)}return components},Javelin.GameObject.prototype.hasTag=function(name){return-1!==this.tags.indexOf(name)},Javelin.GameObject.prototype.addTag=function(name){this.hasTag(name)||this.tags.push(name)},Javelin.GameObject.prototype.removeTag=function(name){this.hasTag(name)&&this.tags.splice(this.tags.indexOf(name),1)},Javelin.GameObject.prototype.getTags=function(){return this.tags},Javelin.GameObject.prototype.getChildrenByTag=function(name,recursive){for(var children=[],i=0;this.children.length>i;i++)if(this.children[i].hasTag(name)&&children.push(this.children[i]),recursive){var nested=this.children[i].getChildrenByTag(name,!0);if(nested)for(var j in nested)children.push(nested[j])}return children},Javelin.GameObject.prototype.isRoot=function(){return null===this.root
},Javelin.GameObject.prototype.getRoot=function(){return this.isRoot()?this:this.root},Javelin.GameObject.prototype.setRoot=function(go){this.root=go;for(var i in this.children)this.children[i].setRoot(go)},Javelin.GameObject.prototype.addChild=function(child){child.parent&&child.parent.removeChild(child),this.setModified(),child.setModified(),child.parent=this,child.setRoot(this.getRoot()),this.children.push(child)},Javelin.GameObject.prototype.setParent=function(parent){parent.addChild(this)},Javelin.GameObject.prototype.removeChild=function(child){child.setModified(),this.setModified(),child.parent=null,this.children.splice(this.children.indexOf(child),1)},Javelin.GameObject.prototype.leaveParent=function(){this.parent&&this.parent.removeChild(this)},Javelin.GameObject.prototype.abandonChildren=function(){for(var i=0;this.children.length>i;i++)this.removeChild(this.children[i])},Javelin.GameObject.prototype.hasChildren=function(){return this.children.length>0},Javelin.GameObject.prototype.hasParent=function(){return this.parent?!0:!1},Javelin.GameObject.prototype.on=function(name,listener){this.dispatcher.on(name,listener)},Javelin.GameObject.prototype.emit=function(name,data){this.dispatcher.dispatch(name,data)&&(this.parent&&this.parent.emit(name,data),this.isRoot()&&this.engine&&this.engine.emit(name,data))},Javelin.GameObject.prototype.broadcast=function(name,data){if(this.dispatcher.dispatch(name,data)){if(this.children)for(var i=0;this.children.length>i;i++)if(!this.children[i].broadcast(name,data))return!1;return!0}return!1},Javelin.GameObject.prototype.getCallbacks=function(eventName,recursive){return this.modified&&(this.rebuildCallbackCache(),this.modified=!1),recursive?this.allCallbackCache[eventName]||[]:this.ownCallbackCache[eventName]||[]},Javelin.GameObject.prototype.rebuildCallbackCache=function(){var key,i,ownCallbacks={};for(var comp in this.components)for(key in this.components[comp].$callbacks)ownCallbacks[key]=ownCallbacks[key]||[],ownCallbacks[key].push(this.components[comp].$callbacks[key]);this.ownCallbackCache=ownCallbacks;var allCallbacks={};for(key in ownCallbacks){allCallbacks[key]=allCallbacks[key]||[];for(i in ownCallbacks[key])allCallbacks[key].push(ownCallbacks[key][i])}for(i in this.children){var child=this.children[i];child.modified&&(child.rebuildCallbackCache(),child.modified=!1);for(var eventName in child.allCallbackCache){allCallbacks[eventName]=allCallbacks[eventName]||[];for(i in child.allCallbackCache[eventName])allCallbacks[eventName].push(child.allCallbackCache[eventName][i])}}this.allCallbackCache=allCallbacks},Javelin.GameObject.prototype.setModified=function(){this.modified=!0,this.parent&&this.parent.setModified()},Javelin.GameObject.prototype.export=function(){var serialized={name:this.name,layer:this.layer,tags:this.tags,components:{}};for(var alias in this.components)serialized.components[alias]=this.components[alias].$serialize();if(this.children.length>0){serialized.children=[];for(var index in this.children)serialized.children.push(this.children[index].export())}return serialized},Javelin.GameObjectComponent=function(){this.$callbacks={},this.$go=null,this.$id=-1,this.$alias="",this.$inheritedAliases=[]},Javelin.GameObjectComponent.prototype.$on=function(name,callback){callback.$id=this.$id,this.$callbacks[name]=callback,this.$go&&this.$go.setModified()},Javelin.GameObjectComponent.prototype.$instanceOf=function(alias){return-1!==this.$inheritedAliases.indexOf(alias)},Javelin.GameObjectComponent.prototype.$getCallback=function(name){return this.$callbacks[name]||!1},Javelin.GameObjectComponent.prototype.$serialize=function(){var data={};for(var key in this)"function"!=typeof this[key]&&"$"!==key.charAt(0)&&(data[key]=this[key]);return data},Javelin.GameObjectComponent.prototype.$unserialize=function(data){for(var key in data)this[key]=data[key]},Javelin.Env.Browser=function(config){this.config=config,this.engine=null,this.intervalId=null},Javelin.Env.Browser.prototype=new Javelin.Environment,Javelin.Env.Browser.prototype.run=function(stepsPerSecond){var engine=this.engine;this.intervalId=setInterval(function(){try{engine.step()}catch(e){console.log(e),engine.debug&&alert(e)}},stepsPerSecond)},Javelin.Env.Browser.prototype.stop=function(callback){clearInterval(this.intervalId),setTimeout(callback,1)},Javelin.Env.Server=function(){this.engine={}},Javelin.Env.Server.prototype=new Javelin.Environment,Javelin.Env.Server.prototype.run=function(){},Javelin.Plugin.Audio=function(plugin){plugin.$onLoad=function(){window?(plugin.listener=null,plugin.audioContext=null,plugin.masterVolumeNode=null,plugin.loader=null,plugin.callbacks={},plugin.buffers={},plugin.active={},plugin.audioContext=new webkitAudioContext,plugin.masterVolumeNode=plugin.audioContext.createGainNode(1),plugin.masterVolumeNode.connect(plugin.audioContext.destination),plugin.loader=plugin.$engine.loader):plugin.$active=!1},plugin.$onUnload=function(){for(var id in plugin.active)plugin.stopSound(id)},plugin.loadSound=function(path,callback){plugin.loader.loadAsset(path,function(arraybuffer){plugin.audioContext.decodeAudioData(arraybuffer,function(audioBuffer){plugin.buffers[path]=audioBuffer,callback()},function(){console.log("Failed decoding audio from "+path)})})},plugin.playSound=function(path,emitter,transform,loop,cull){if(!plugin.buffers[path])return plugin.loadSound(path,function(){plugin.playSound(path,emitter,transform,loop,cull)}),void 0;var source=plugin.audioContext.createBufferSource();source.buffer=plugin.buffers[path];var id=emitter.$id;plugin.active[id]=plugin.active[id]||{},loop&&(source.loop=!0),emitter.spatial?(cull=!1,cull||(source.connect(plugin.masterVolumeNode),plugin.active[id][path]={source:source,path:path,goId:emitter.$id,emitter:emitter,transform:transform,startTime:Date.now(),duration:source.buffer.duration,finished:!1,filterNodes:{}})):(source.connect(plugin.masterVolumeNode),plugin.active[id][path]={source:source,path:path,goId:emitter.$id,emitter:emitter,transform:transform,startTime:Date.now(),duration:source.buffer.duration,loop:!1,finished:!1}),source.noteOn(0)},plugin.stopSound=function(id,path){path=path||!1;var p;if(plugin.active[id])if(path){if(plugin.active[id][path])for(p in plugin.active[id])p===path&&(plugin.active[id][p].source.noteOff(0),plugin.active[id][p].source.disconnect(0),plugin.active[id][p]=null)}else{for(p in plugin.active[id])null!==plugin.active[id][p]&&(plugin.active[id][p].source.noteOff(0),plugin.active[id][p].source.disconnect(0));plugin.active[id]=null}},plugin.clearActive=function(id){plugin.active[id]=null},plugin.$onGameObjectCreate=function(gameObject){var listener=gameObject.getComponent("audioListener");listener&&(plugin.listener=gameObject);var cbs=gameObject.getCallbacks("audio.resolve");cbs&&(plugin.callbacks[gameObject.id]=cbs)},plugin.$onGameObjectDestroy=function(gameObject){plugin.callbacks[gameObject.id]&&(plugin.callbacks[gameObject.id]=null),plugin.stopSound(gameObject.id)},plugin.$onPostUpdateStep=function(){if(plugin.listener){plugin.listener.getComponent("transform2d").position;for(var id in plugin.active)for(var path in plugin.active[id]);}}},Javelin.Plugin.Audio.alias="audio",Javelin.Plugin.Box2d=function(plugin,config){var velocityIterations=config.velocityIterations||10,positionIterations=config.positionIterations||10,stepHZ=config.stepHZ||1/30,clearForces=config.clearForces||!1;1/(config.stepsPerSecond||1e3/30);var stepsPerSecond=config.stepsPerSecond||1e3/30,gravityX=config.gravityX||0,gravityY=config.gravityY||0,lastTimeStepped=Date.now(),allowSleep=config.allowSleep||!1;Box2D&&(plugin.Vec2=Box2D.Common.Math.b2Vec2,plugin.BodyDef=Box2D.Dynamics.b2BodyDef,plugin.Body=Box2D.Dynamics.b2Body,plugin.FixtureDef=Box2D.Dynamics.b2FixtureDef,plugin.Fixture=Box2D.Dynamics.b2Fixture,plugin.World=Box2D.Dynamics.b2World,plugin.MassData=Box2D.Collision.Shapes.b2MassData,plugin.PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,plugin.CircleShape=Box2D.Collision.Shapes.b2CircleShape,plugin.DebugDraw=Box2D.Dynamics.b2DebugDraw,plugin.RevoluteJointDef=Box2D.Dynamics.Joints.b2RevoluteJointDef,plugin.worldInstance=null,plugin.bodies={},plugin.applyRadialForce=function(x,y,impulse,radius,implode,callback){var center=new plugin.Vec2(x,y),aa=new plugin.Vec2(x-radius,y-radius),bb=new plugin.Vec2(x+radius,y+radius),aabb=new Box2D.Collision.b2AABB;aabb.upperBound=bb,aabb.lowerBound=aa,plugin.worldInstance.QueryAABB(function(fixture){var body=fixture.GetBody(),go=body.GetUserData(),targetPos=body.GetPosition();if(fixture.IsSensor())return!0;var distance=Box2D.Common.Math.b2Math.Distance(center,body.GetPosition());if(distance>=radius)return!0;var angle,amount=radius-distance,strength=amount/radius,force=impulse*strength;return angle=implode?Math.atan2(center.y-targetPos.y,center.x-targetPos.x):Math.atan2(targetPos.y-center.y,targetPos.x-center.x),body.ApplyForce(new plugin.Vec2(Math.cos(angle)*force,Math.sin(angle)*force),body.GetPosition()),callback&&callback(go),!0},aabb)},plugin.raycast=function(){},plugin.$onLoad=function(){plugin.worldInstance=null,plugin.worldInstance=new plugin.World(new plugin.Vec2(gravityX,gravityY),allowSleep);var contactListener=new Box2D.Dynamics.b2ContactListener;if(contactListener.PreSolve=function(){},contactListener.BeginContact=function(contact){var goA=contact.GetFixtureA().GetBody().GetUserData(),goB=contact.GetFixtureB().GetBody().GetUserData(),isTrigger=goA.getComponent("rigidbody2d").trigger||goB.getComponent("rigidbody2d").trigger,event=isTrigger?"box2d.trigger.enter":"box2d.collision.enter";plugin.callGoCallbacks(event,goA,goB,contact),plugin.callGoCallbacks(event,goB,goA,contact)},contactListener.EndContact=function(contact){var goA=contact.GetFixtureA().GetBody().GetUserData(),goB=contact.GetFixtureB().GetBody().GetUserData(),isTrigger=goA.getComponent("rigidbody2d").trigger||goB.getComponent("rigidbody2d").trigger,event=isTrigger?"box2d.trigger.exit":"box2d.collision.exit";plugin.callGoCallbacks(event,goA,goB,contact),plugin.callGoCallbacks(event,goB,goA,contact)},contactListener.PostSolve=function(){},plugin.worldInstance.SetContactListener(contactListener),plugin.$engine&&plugin.$engine.debug){var debugDraw=new Box2D.Dynamics.b2DebugDraw;debugDraw.SetSprite(plugin.$engine.getPlugin("canvas2d").context)}},plugin.callGoCallbacks=function(name,goA,goB,contact){var cbs=goA.getCallbacks(name);if(cbs.length)for(var i in cbs)cbs[i](goB,contact)},plugin.$onPostUpdateStep=function(){var i,j,cbs,gos=plugin.$engine.gos;for(i in gos)if(gos[i].enabled&&(cbs=gos[i].getCallbacks("box2d.update")))for(j in cbs)cbs[j](lastTimeStepped);plugin.$engine.time-lastTimeStepped>=stepsPerSecond&&(plugin.worldInstance.Step(stepHZ,velocityIterations,positionIterations),clearForces&&plugin.worldInstance.ClearForces(),lastTimeStepped=Date.now());for(i in gos)if(gos[i].enabled&&(cbs=gos[i].getCallbacks("box2d.lateUpdate")))for(j in cbs)cbs[j](lastTimeStepped)},plugin.$onGameObjectCreate=function(gameObject){var rigidbody=gameObject.getComponent("rigidbody2d");if(rigidbody){var bodyDef=rigidbody.createBodyDefinition(),body=plugin.worldInstance.CreateBody(bodyDef),fixtureDef=rigidbody.createFixtureDefinition(),fixture=body.CreateFixture(fixtureDef);rigidbody.setFixture(fixture),rigidbody.setBody(body),plugin.bodies[gameObject.id]=body}},plugin.$onGameObjectDestroy=function(gameObject){var rigidbody=gameObject.getComponent("rigidbody2d");rigidbody&&plugin.worldInstance.DestroyBody(rigidbody.getBody()),plugin.bodies[gameObject.id]=null})},Javelin.Plugin.Box2d.alias="box2d",Javelin.Plugin.Canvas2d=function(plugin,config){plugin.config=config,plugin.renderTarget=null,plugin.cameras={},plugin.contexts={},plugin.canvases={},plugin.$onLoad=function(){if(document){plugin.fps=plugin.config.framesPerSecond||plugin.$engine.stepsPerSecond,plugin.lastTimeRendered=0;var target=document.getElementById(plugin.config.renderTargetId);if(plugin.renderTarget=target,target.offsetTop,target.offsetLeft,!target)throw Error("No render target defined!");plugin.config.layers||(plugin.config.layers=["default"]);var z=0;for(var i in plugin.config.layers){z++;var layer=plugin.config.layers[i],canvas=document.createElement("canvas");canvas.height=plugin.config.height,canvas.width=plugin.config.width,canvas.style.zIndex=z,canvas.id="javelin-layer-"+layer,plugin.canvases[layer]=canvas,plugin.contexts[layer]=canvas.getContext("2d"),plugin.cameras[layer]={x:0,y:0,height:0,width:0},target.appendChild(canvas)}}else plugin.$active=!1},plugin.$onUnload=function(){for(var i in plugin.canvases)plugin.renderTarget.removeChild(plugin.canvases[i])},plugin.$onPostUpdateStep=function(){if(plugin.$engine.time-plugin.lastTimeRendered>=plugin.fps&&!plugin.$engine.isRunningSlowly){var i,j,ctx,camera;for(i in plugin.canvases)plugin.contexts[i].clearRect(0,0,plugin.canvases[i].width,plugin.canvases[i].height);var gos=plugin.$engine.gos,l=gos.length;for(i=0;l>i;i++)if(gos[i].enabled&&gos[i].isRoot()){ctx=plugin.contexts[gos[i].layer],camera=plugin.cameras[gos[i].layer];var cbs=gos[i].getCallbacks("canvas2d.draw",!0);for(j in cbs)cbs[j](ctx,camera)}plugin.lastTimeRendered=plugin.$engine.time}}},Javelin.Plugin.Canvas2d.alias="canvas2d",Javelin.Plugin.Input=function(plugin,config){plugin.config=config,plugin.handlers={},plugin.callbacks={},plugin.input={},plugin.$onLoad=function(){if(plugin.config.keyboard){var kb=plugin.handlers.keyboard=new Javelin.Plugin.Input.Handler.Keyboard(plugin,plugin.config.keyboard);"undefined"!=typeof window&&kb.registerListeners()}},plugin.$onUnload=function(){plugin.handlers.keyboard&&plugin.handlers.keyboard.unregisterListeners()},plugin.$onPreUpdateStep=function(deltaTime){var i,j,currTime,lastTime;currTime=plugin.$engine.time,lastTime=plugin.$engine.prevTime;for(i in plugin.handlers)plugin.handlers[i].processInputEvents(currTime,lastTime,deltaTime);for(i in plugin.callbacks)if(plugin.callbacks[i])for(j in plugin.callbacks[i])plugin.callbacks[i][j](plugin)},plugin.$onPostUpdateStep=function(){},plugin.$onGameObjectCreate=function(gameObject){var cbs=gameObject.getCallbacks("input.resolve");cbs.length&&(plugin.callbacks[gameObject.id]=cbs)},plugin.$onGameObjectDestroy=function(gameObject){plugin.callbacks[gameObject.id]&&(plugin.callbacks[gameObject.id]=null)},plugin.getInput=function(name){if(!this.input[name])throw Error("Requested input ["+name+"] is not defined.");return this.input[name]||!1},plugin.getButton=function(name){if(!this.input[name])throw Error("Requested input ["+name+"] is not defined.");return this.input[name].val||0},plugin.getButtonDown=function(name){if(!this.input[name])throw Error("Requested input ["+name+"] is not defined.");return this.input[name].down||!1},plugin.getButtonUp=function(name){if(!this.input[name])throw Error("Requested input ["+name+"] is not defined.");return this.input[name].up||!1},plugin.getAxis=function(name){if(!this.input[name])throw Error("Requested input ["+name+"] is not defined.");return this.input[name]||0},plugin.getMousePosition=function(){},plugin.getMouseButton=function(){},plugin.getMouseButtonUp=function(){},plugin.getMouseButtonDown=function(){},plugin.getTouch=function(){},plugin.getTouches=function(){},plugin.getHandler=function(key){return this.handlers[key]||!1},plugin.defineButton=function(name){this.input[name]={up:!1,down:!1,val:0}},plugin.setButton=function(name,val){this.input[name].val=val},plugin.setButtonUp=function(name,val){this.input[name].up=val},plugin.setButtonDown=function(name,val){this.input[name].down=val},plugin.setAxis=function(name,val){this.input[name]=val}},Javelin.Plugin.Input.alias="input",Javelin.Plugin.Input.Handler=Javelin.Plugin.Input.Handler||{},Javelin.Plugin.Input.Handler.Keyboard=function(plugin,config){this.raw={},this.plugin=plugin,this.MAP={a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,space:32,enter:13,control:17,alt:18,"delete":46,backspace:8,shift:16,escape:27,uparrow:38,downarrow:40,leftarrow:37,rightarrow:39},config&&this.processConfig(config);var kb=this;this.keyUpListener=function(e){kb.handleKeyUp(e)},this.keyDownListener=function(e){kb.handleKeyDown(e)}},Javelin.Plugin.Input.Handler.Keyboard.prototype.registerListeners=function(){window.addEventListener("keyup",this.keyUpListener),window.addEventListener("keydown",this.keyDownListener)},Javelin.Plugin.Input.Handler.Keyboard.prototype.unregisterListeners=function(){window.removeEventListener("keyup",this.keyUpListener),window.removeEventListener("keydown",this.keyDownListener)},Javelin.Plugin.Input.Handler.Keyboard.prototype.processInputEvents=function(){for(var code in this.raw){var raw=this.raw[code];raw.axis||(raw.up&&(this.plugin.setButtonUp(raw.control,!0),this.plugin.setButtonDown(raw.control,!1),this.plugin.setButton(raw.control,0)),raw.down&&(this.plugin.setButtonUp(raw.control,!1),this.plugin.setButtonDown(raw.control,!0),this.plugin.setButton(raw.control,1)))}},Javelin.Plugin.Input.Handler.Keyboard.prototype.processConfig=function(config){this.config=config,this.raw={};var control;if(config.buttons)for(control in config.buttons)this.MAP[config.buttons[control]]&&(this.plugin.defineButton(control),this.raw[this.MAP[config.buttons[control]]]={up:!1,down:!1,time:Date.now(),axis:!1,control:control});if(config.axes)for(control in config.axes);},Javelin.Plugin.Input.Handler.Keyboard.prototype.getKeyId=function(event){var codes=[];return event.keyCode&&codes.push(event.keyCode),event.altKey&&codes.push(18),event.ctrlKey&&codes.push(17),event.shift&&codes.push(16),codes},Javelin.Plugin.Input.Handler.Keyboard.prototype.handleKeyDown=function(event){var codes=this.getKeyId(event);for(var i in codes)if(this.raw[codes[i]]){event.preventDefault();var key=this.raw[codes[i]];key.down=!0,key.up=!1,key.time=Date.now()}},Javelin.Plugin.Input.Handler.Keyboard.prototype.handleKeyUp=function(event){var codes=this.getKeyId(event);for(var i in codes)if(this.raw[codes[i]]){event.preventDefault();var key=this.raw[codes[i]];key.down=!1,key.up=!0,key.time=Date.now()}},"undefined"!=typeof module?module.exports=Javelin:this.Javelin=Javelin}).apply(this);